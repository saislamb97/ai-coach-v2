<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light only">
  <title>AI Coach â€” Realtime Chat (WebSocket)</title>

  <!-- Tailwind (with Typography plugin) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- html2pdf (for client-side PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* Screen polish */
    html, body { background:#f8fafc; }
    .link-underline { text-decoration: underline; text-underline-offset: 2px; }

    /* Code & prose tweaks (readable on screen and print) */
    .prose pre { background:#f2f4f8; color:#021022; border-radius: 0.5rem; }
    .prose pre code.hljs { background:transparent; color:inherit; }
    .prose :not(pre) > code { background:#f1f5f9; color:#334155; padding:.1rem .35rem; border-radius:.35rem; }

    /* Prefer natural wrapping; keep tokens intact */
    .prose pre { white-space: pre-wrap; word-break: normal; overflow-wrap: break-word; }
    .prose code { word-break: normal; overflow-wrap: break-word; }

    /* Table scroll on small screens (fade edges) */
    .scroll-shadow {
      -webkit-mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
              mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
    }

    /* PRINT: page & break behavior tuned for html2pdf */
    @page { size: A4; margin: 20mm; }
    @media print {
      .no-print { display: none !important; }
      body { background:white; }
      main { max-width: 100% !important; }
      .prose p,
      .prose pre,
      .prose blockquote,
      .prose table,
      .prose ul,
      .prose ol { break-inside: avoid; page-break-inside: avoid; }
      h1, h2, h3, h4 { break-after: avoid-page; page-break-after: avoid; }
      .prose p { orphans: 3; widows: 3; }
      * { transform: none !important; }
    }

    .page-break-before { break-before: page; page-break-before: always; }
    .page-break-after  { break-after:  page; page-break-after:  always; }
    .pdf-avoid-break   { break-inside: avoid; page-break-inside: avoid; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <!-- Sticky Header (excluded from exported PDF) -->
  <header class="no-print sticky top-0 z-40 border-b border-slate-200 bg-white/90 backdrop-blur">
    <div class="mx-auto flex max-w-7xl items-center justify-between gap-3 px-4 py-3">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-indigo-600"></div>
        <div class="leading-tight">
          <div class="text-sm font-semibold text-slate-900">AI Coach â€” Realtime Chat (WebSocket)</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="window.print()" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-3a2 2 0 00-2-2h-1V7a2 2 0 00-2-2h-8a2 2 0 00-2 2v3H5a2 2 0 00-2 2v3a2 2 0 002 2h2m10 0v4H7v-4m10 0H7"/></svg>
          Print / Save as PDF
        </button>
        <button id="btn-pdf" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 2H8a2 2 0 0 0-2 2v3h2V4h11v16H8v-3H6v3a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2ZM7 13h4a3 3 0 0 0 0-6H7v6Zm2-2v-2h2a1 1 0 1 1 0 2H9Zm-5 6h2v-2h2a3 3 0 0 0 0-6H4v8Z"/></svg>
          Download PDF
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto grid max-w-7xl grid-cols-1 gap-8 px-4 py-8 lg:grid-cols-[18rem_1fr]">
    <!-- TOC -->
    <aside class="no-print lg:sticky lg:top-20 lg:self-start">
      <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="mb-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Table of Contents</div>
        <nav id="toc" class="space-y-2 text-sm"></nav>
      </div>
    </aside>

    <!-- Content -->
    <article id="readme-root" class="prose prose-slate max-w-none">
      <h1 id="ai-coach-realtime-chat">AI Coach â€” Realtime Chat (WebSocket)</h1>

      <div class="not-prose my-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-xl border border-slate-200 bg-white p-3">
          <div class="text-xs uppercase tracking-wide text-slate-500">Version</div>
          <div class="mt-1 font-semibold">1.0.0</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-3">
          <div class="text-xs uppercase tracking-wide text-slate-500">Date</div>
          <div class="mt-1 font-semibold">2025-10-30</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white p-3 lg:col-span-2">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-500">Base URL</div>
              <div class="mt-1 font-semibold">
                <a href="https://ai-coach-pmkn.onrender.com/" class="link-underline text-indigo-700">https://ai-coach-pmkn.onrender.com/</a>
              </div>
            </div>
            <button class="ml-2 rounded-lg border border-slate-200 px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-50"
              onclick="copyText(event, 'https://ai-coach-pmkn.onrender.com/')">Copy</button>
          </div>
        </div>
      </div>

      <h2 id="overview">Overview</h2>
      <p>This document focuses on the <strong>WebSocket</strong> API for AI Coach realtime chat (token + sentence streaming, optional TTS+visemes, slide updates). For the REST API, see the links in <a href="#api-docs">API Docs</a>.</p>

      <div class="not-prose my-4 rounded-xl border border-amber-300 bg-amber-50 p-4 text-amber-900">
        <div class="font-semibold">ðŸ”‘ Requirements</div>
        <ul class="mt-2 list-disc pl-6">
          <li><code>Api-Key</code> (tenant-scoped)</li>
          <li><code>bot_id</code> (UUID of the Agent)</li>
          <li><code>thread_id</code> shaped as <code>^user_[0-9a-f]{16}$</code> (example: <code>user_ab12cd34ef56gh78</code>)</li>
          <li>Origin/Host/IP must be allow-listed for the API key</li>
        </ul>
      </div>

      <h2 id="ws-endpoint">WebSocket Endpoint</h2>
      <pre><code class="language-http">wss://ai-coach-pmkn.onrender.com/ws/chat/?bot_id=&lt;uuid&gt;&amp;thread_id=&lt;user_16hex&gt;&amp;website_language=en</code></pre>

      <h3 id="ws-auth">Authentication &amp; Allow-list</h3>
      <ul>
        <li>Provide the API key via one of:
          <ul>
            <li>Header: <code>Authorization: Api-Key &lt;YOUR_API_KEY&gt;</code></li>
            <li>Query param: <code>?api_key=&lt;YOUR_API_KEY&gt;</code></li>
            <li>Cookie: <code>api_key=&lt;YOUR_API_KEY&gt;</code></li>
          </ul>
        </li>
        <li>Additionally, at least one of the allow-list checks must pass: Origin/Referer host, Host header, or client IP/CIDR.</li>
      </ul>

      <h3 id="ws-params">Query Parameters</h3>
      <table class="not-prose min-w-full text-sm rounded-xl border border-slate-200 bg-white">
        <thead class="bg-slate-50 text-left text-slate-600">
          <tr><th class="px-4 py-2">Param</th><th class="px-4 py-2">Type</th><th class="px-4 py-2">Notes</th></tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <tr><td class="px-4 py-2 font-mono">bot_id</td><td class="px-4 py-2">UUID</td><td class="px-4 py-2">Agent identifier</td></tr>
          <tr><td class="px-4 py-2 font-mono">thread_id</td><td class="px-4 py-2">string</td><td class="px-4 py-2">Must match <code>^user_[0-9a-f]{16}$</code></td></tr>
          <tr><td class="px-4 py-2 font-mono">website_language</td><td class="px-4 py-2">string</td><td class="px-4 py-2">UI hint (e.g., <code>en</code>)</td></tr>
          <tr><td class="px-4 py-2 font-mono">api_key</td><td class="px-4 py-2">string</td><td class="px-4 py-2">Optional if using header/cookie</td></tr>
        </tbody>
      </table>

      <h3 id="ws-limits">Limits &amp; Behavior</h3>
      <ul>
        <li><strong>Inbound message rate:</strong> up to <code>20 Hz</code> (excess is ignored).</li>
        <li><strong>Audio upload size:</strong> up to <code>25 MiB</code>.</li>
        <li><strong>Audio formats:</strong> auto-detected from data URL or hint: <code>webm</code>, <code>wav</code>, <code>m4a</code>, <code>ogg</code>, <code>mp3</code>.</li>
        <li><strong>STT model:</strong> <code>OPENAI_STT_MODEL</code> env (default <code>whisper-1</code>).</li>
        <li><strong>Thread safety:</strong> one active run at a time; new queries cancel the previous run.</li>
      </ul>

      <h2 id="ws-messages">Message Reference</h2>

      <h3 id="client-to-server">Client â†’ Server</h3>
      <pre><code class="language-json">{
  "type": "text_query",
  "text": "Hello there",
  "local_time": "2025-10-30 10:00:00",
  "muteAudio": false
}
{
  "type": "audio_query",
  "audio": "data:audio/webm;base64,AAAAâ€¦",
  "format": "webm",
  "muteAudio": true
}
{ "type": "mute_audio" }
{ "type": "unmute_audio" }
{ "type": "stop_audio" }
{ "type": "ping" }</code></pre>

      <ul>
        <li><code>text_query</code>: starts a new run; server echoes <code>audio_muted</code> state.</li>
        <li><code>audio_query</code>: server transcribes then runs as a <code>text_query</code>.</li>
        <li><code>mute_audio</code>/<code>unmute_audio</code>: toggles TTS streaming.</li>
        <li><code>stop_audio</code>: stops further <code>audio_response</code> chunks for the current run.</li>
        <li><code>ping</code>: liveness check; server replies <code>pong</code>.</li>
      </ul>

      <h3 id="server-to-client">Server â†’ Client</h3>
      <ul>
        <li><code>connected</code> â€” handshake info: <code>{ bot_id, thread_id }</code></li>
        <li><code>text_query</code> â€” echo of user message <em>(with <code>local_time</code>)</em></li>
        <li><code>response_start</code> â†’ <code>text_token</code>* â†’ <code>text_sentence</code>* â†’ <code>response_done</code> â†’ <code>response_ended</code></li>
        <li><code>audio_muted</code> â€” <code>{ muted: boolean }</code></li>
        <li><code>audio_response</code> â€” <code>{ audio: base64, viseme: number[][], local_time }</code></li>
        <li><code>slides_response</code> â€” <code>{ slides: { title, summary, editorjs }, local_time }</code></li>
        <li><code>slides_done</code> â€” end-of-slides marker</li>
        <li><code>stop_audio</code> â€” confirmation</li>
        <li><code>pong</code> â€” ping reply</li>
        <li><code>error</code> â€” <code>{ message }</code></li>
      </ul>

      <p><em>*Streaming:</em> <code>text_token</code> carries raw tokens; <code>text_sentence</code> emits finalized sentences with optional emotion:</p>
      <pre><code class="language-json">{
  "type": "text_sentence",
  "text": "Let's start with a simple plan.",
  "emotion": {
    "items": [
      {"name":"Joy","intensity":2},
      {"name":"Anger","intensity":1},
      {"name":"Sadness","intensity":1}
    ]
  },
  "local_time": "2025-10-30 10:00:02"
}</code></pre>

      <h3 id="timings-payload">Timings Payload</h3>
      <pre><code class="language-json">{
  "type": "response_done",
  "timings": {
    "prepare_ms": 41,
    "run_ms": 1850,
    "total_ms": 2104,
    "ws_total_sec": 2.12
  }
}</code></pre>

      <h3 id="close-codes">Connection Close Codes (common)</h3>
      <ul>
        <li><code>4403</code> â€” auth failed (bad/missing API key or allow-list)</li>
        <li><code>4000</code> â€” missing required query params</li>
        <li><code>4004</code> â€” agent not found/inactive</li>
        <li><code>4005</code> â€” invalid <code>thread_id</code> pattern or session not found</li>
      </ul>

      <h2 id="examples">Examples</h2>

      <h3 id="example-js">JavaScript (browser)</h3>
      <pre><code class="language-javascript">const url = new URL("wss://ai-coach-pmkn.onrender.com/ws/chat/");
url.searchParams.set("bot_id", "6a97a3c4-5d25-47a8-bb31-b6f35c98e6b7");
url.searchParams.set("thread_id", "user_ab12cd34ef56gh78");
url.searchParams.set("website_language", "en");
url.searchParams.set("api_key", "&lt;YOUR_API_KEY&gt;");

const ws = new WebSocket(url);
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: "text_query",
    text: "Hello Coach!",
    local_time: new Date().toLocaleString(),
    muteAudio: false
  }));
};
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === "text_token")   {/* render tokens */}
  if (msg.type === "text_sentence"){/* render sentence + emotion */}
  if (msg.type === "audio_response"){/* queue/play base64 audio */}
};</code></pre>

      <h3 id="example-python">Python (websockets)</h3>
      <pre><code class="language-python">import asyncio, json, websockets

API = "&lt;YOUR_API_KEY&gt;"
BOT = "6a97a3c4-5d25-47a8-bb31-b6f35c98e6b7"
THR = "user_ab12cd34ef56gh78"

async def main():
    url = f"wss://ai-coach-pmkn.onrender.com/ws/chat/?bot_id={BOT}&thread_id={THR}&website_language=en"
    async with websockets.connect(url, extra_headers={"Authorization": f"Api-Key {API}"}) as ws:
        await ws.send(json.dumps({"type":"text_query","text":"Plan my week","local_time":"2025-10-30 10:00:00","muteAudio":True}))
        async for raw in ws:
            msg = json.loads(raw)
            print(msg)

asyncio.run(main())</code></pre>

      <h2 id="audio-payload">Audio Payload Tips</h2>
      <ul>
        <li>Send <code>data:audio/&lt;mime&gt;;base64,....</code> (recommended) or plain base64 + <code>format</code> hint.</li>
        <li>Server will infer extension from the data URL or <code>format</code> (<code>wav/m4a/ogg/webm/mp3</code>).</li>
        <li>On playback, consider queueing chunks and handling user mute/stop actions.</li>
      </ul>

      <h2 id="api-docs">API Docs (REST URLs)</h2>
      <div class="not-prose overflow-x-auto scroll-shadow rounded-xl border border-slate-200 bg-white">
        <table class="min-w-[640px] w-full text-sm pdf-avoid-break">
          <thead class="bg-slate-50 text-left text-slate-600">
            <tr>
              <th class="px-4 py-3 font-semibold">Name</th>
              <th class="px-4 py-3 font-semibold">URL</th>
              <th class="px-4 py-3 font-semibold">Notes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            <tr>
              <td class="px-4 py-3 font-medium">Admin</td>
              <td class="px-4 py-3"><a class="link-underline text-indigo-700" href="/admin/">/admin/</a></td>
              <td class="px-4 py-3">Interactive Admin Panel</td>
            </tr>
            <tr>
              <td class="px-4 py-3 font-medium">Swagger UI</td>
              <td class="px-4 py-3"><a class="link-underline text-indigo-700" href="/api/schema/swagger-ui/">/api/schema/swagger-ui/</a></td>
              <td class="px-4 py-3">Interactive API docs</td>
            </tr>
            <tr>
              <td class="px-4 py-3 font-medium">ReDoc</td>
              <td class="px-4 py-3"><a class="link-underline text-indigo-700" href="/api/schema/redoc/">/api/schema/redoc/</a></td>
              <td class="px-4 py-3">Reference docs</td>
            </tr>
            <tr>
              <td class="px-4 py-3 font-medium">Raw Schema</td>
              <td class="px-4 py-3"><a class="link-underline text-indigo-700" href="/api/schema/">/api/schema/</a></td>
              <td class="px-4 py-3">OpenAPI JSON</td>
            </tr>
            <tr>
              <td class="px-4 py-3 font-medium">Test Endpoint</td>
              <td class="px-4 py-3"><a class="link-underline text-indigo-700" href="/api/test/">/api/test/</a></td>
              <td class="px-4 py-3">WS &amp; REST console</td>
            </tr>
          </tbody>
        </table>
      </div>

    </article>
  </main>

  <footer class="mx-auto max-w-7xl px-4 pb-10">
    <div class="rounded-2xl border border-slate-200 bg-white p-4 text-center text-xs text-slate-500">
      Â© 2025 AI Coach â€” Realtime Chat Docs. Use the buttons above to print or download as PDF.
    </div>
  </footer>

  <script>
    // Highlight.js
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    });

    // Build TOC from h2/h3 (stable anchors)
    (function buildTOC() {
      const toc = document.getElementById('toc');
      const article = document.getElementById('readme-root');
      const headings = [...article.querySelectorAll('h2, h3')];
      const list = document.createElement('ul');
      list.className = 'space-y-1';
      headings.forEach(h => {
        if (!h.id) {
          h.id = h.textContent.toLowerCase().replace(/[^\w]+/g, '-').replace(/^-+|-+$/g, '');
        }
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent;
        a.className = (h.tagName === 'H2')
          ? 'block font-medium text-slate-700 hover:text-indigo-700'
          : 'ml-3 block text-slate-600 hover:text-indigo-700';
        li.appendChild(a);
        list.appendChild(li);
      });
      toc.appendChild(list);
    })();

    // Copy helper
    function copyText(evt, text) {
      navigator.clipboard.writeText(text).then(() => {
        const btn = evt.currentTarget;
        const original = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = original), 1200);
      });
    }
  </script>

  <script>
    // Robust PDF export (article only) with header + pagination
    document.getElementById('btn-pdf').addEventListener('click', () => {
      const element = document.getElementById('readme-root');
      element.querySelectorAll('pre').forEach(pre => {
        pre.style.whiteSpace = 'pre-wrap';
        pre.style.wordBreak   = 'normal';
        pre.style.overflowWrap= 'break-word';
      });

      const opt = {
        margin: [24, 24, 24, 24],
        filename: 'AI-Coach-WebSocket-Doc.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false,
          windowWidth: document.documentElement.scrollWidth
        },
        jsPDF: { unit: 'pt', format: 'legal', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy', 'avoid-all'], avoid: 'p, pre, blockquote, table, h2, h3' }
      };

      const title = 'AI Coach â€” Realtime Chat (WebSocket)';
      const date  = '2025-10-30';

      html2pdf().set(opt).from(element).toPdf().get('pdf').then(pdf => {
        const pageCount = pdf.internal.getNumberOfPages();
        const pageW = pdf.internal.pageSize.getWidth();
        const left = 28; const right = pageW - 28;

        for (let i = 1; i <= pageCount; i++) {
          pdf.setPage(i);

          // Header
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(9);
          pdf.text(title, left, 18, { maxWidth: pageW - 56 });
          pdf.setFont('helvetica', 'normal');
          pdf.text(date, right, 18, { align: 'right' });

          // Divider
          pdf.setDrawColor(200);
          pdf.setLineWidth(0.5);
          pdf.line(24, 22, pageW - 24, 22);

          // Footer (page numbers)
          pdf.setFontSize(9);
          pdf.setTextColor(100);
          pdf.text(`Page ${i} of ${pageCount}`, right, pdf.internal.pageSize.getHeight() - 12, { align: 'right' });
        }
      }).save();
    });
  </script>
</body>
</html>
