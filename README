# AI Coach API & Realtime Chat ‚Äî README

**Version:** 1.0.0
**Date:** 2025-10-30
**Base URL (prod):** `https://ai-coach-pmkn.onrender.com`

---

## Overview

This service exposes a focused REST API (DRF + Spectacular) and a WebSocket endpoint to:

* Manage **Voices**, **Agents**, **Sessions**, **Chats**, **Slides**
* Stream real-time chat via **WebSocket** (with optional TTS + visemes)
* Browse OpenAPI docs (Swagger UI / ReDoc / raw schema)
* Use an in-browser **Test Console** to exercise endpoints

> üîë You will need:
>
> * `Api-Key` (tenant-scoped)
> * `bot_id` (UUID of the Agent you‚Äôll use)
> * A `thread_id` of shape `user_16hex` (example: `user_ab12cd34ef56gh78`)

---

## Quick Links

| Name                             | URL                                                         | Notes            |
| -------------------------------- | ----------------------------------------------------------- | ---------------- |
| **Main site**                    | `https://ai-coach-pmkn.onrender.com/`                       | Landing          |
| **Swagger UI**                   | `https://ai-coach-pmkn.onrender.com/api/schema/swagger-ui/` | Interactive docs |
| **ReDoc**                        | `https://ai-coach-pmkn.onrender.com/api/schema/redoc/`      | Reference docs   |
| **Raw OpenAPI Schema**           | `https://ai-coach-pmkn.onrender.com/api/schema/`            | JSON schema      |
| **Test Endpoint (HTML Console)** | `https://ai-coach-pmkn.onrender.com/api/test/`              | Try WS & REST    |

---

## Authentication & Allow-list

### REST

Include on **all REST** requests:

```
Authorization: Api-Key <YOUR_API_KEY>
```

### WebSocket

Provide the API key via **one** of:

1. Header: `Authorization: Api-Key <YOUR_API_KEY>`
2. Query param: `?api_key=<YOUR_API_KEY>`
3. Cookie: `api_key=<YOUR_API_KEY>`

### Origin / Host / IP Allow-list

Requests must also pass at least one allow-list check (configured per key):

* Origin/Referer host is allowed, **or**
* Host header is allowed, **or**
* Client IP/CIDR is allowed

Errors are standardized by DRF with a meaningful message.

---

## Response & Pagination

List endpoints use DRF page-number pagination:

```json
{
  "count": 42,
  "next": "https://.../api/agents/?page=3&page_size=10",
  "previous": "https://.../api/agents/?page=1&page_size=10",
  "results": [ /* items */ ]
}
```

Use `?page=` and `?page_size=` (1‚Äì100). Field sets are defined by the API serializers (see Swagger UI).

---

## REST Endpoints

All resources follow standard ViewSet routes: `list`, `retrieve`, `create`, `update`, `partial_update`, `destroy`.

> Base prefix for all routes below is `/api/`.

### 1) Voices

```
GET    /api/voices/
POST   /api/voices/
GET    /api/voices/{id}/
PATCH  /api/voices/{id}/
PUT    /api/voices/{id}/
DELETE /api/voices/{id}/
```

**Example ‚Äî List:**

```bash
curl -H "Authorization: Api-Key $API_KEY" \
  https://ai-coach-pmkn.onrender.com/api/voices/
```

---

### 2) Agents

```
GET    /api/agents/
POST   /api/agents/
GET    /api/agents/{id}/
PATCH  /api/agents/{id}/
PUT    /api/agents/{id}/
DELETE /api/agents/{id}/
```

**Example ‚Äî Retrieve one:**

```bash
curl -H "Authorization: Api-Key $API_KEY" \
  https://ai-coach-pmkn.onrender.com/api/agents/1/
```

> ‚ÑπÔ∏è **SmartMediaMiddleware** upgrades relative media paths to absolute URLs in JSON responses where applicable (e.g., thumbnails, avatar files).

---

### 3) Sessions

```
GET    /api/sessions/
POST   /api/sessions/
GET    /api/sessions/{id}/
PATCH  /api/sessions/{id}/
PUT    /api/sessions/{id}/
DELETE /api/sessions/{id}/
```

Sessions are the durable containers for a user‚Äôs conversation (`thread_id` ~ `user_16hex`) and associated `agent`.
Creation details depend on your serializer; see Swagger UI for required fields.

---

### 4) Chats

```
GET    /api/chats/
POST   /api/chats/
GET    /api/chats/{id}/
PATCH  /api/chats/{id}/
PUT    /api/chats/{id}/
DELETE /api/chats/{id}/
```

Chat entries are persisted automatically by the realtime pipeline after each completed response.
The `POST` route exists but is typically used for admin/import flows rather than live generation.

---

### 5) Slides

```
GET    /api/slides/
POST   /api/slides/
GET    /api/slides/{id}/
PATCH  /api/slides/{id}/
PUT    /api/slides/{id}/
DELETE /api/slides/{id}/
```

Slides store an **Editor.js** document (`editorjs`), plus optional `title`/`summary`.
The engine can synthesize/extend slides and persist them to the session automatically.

---

## WebSocket ‚Äî `/ws/chat/`

**Endpoint**

```
wss://ai-coach-pmkn.onrender.com/ws/chat/?bot_id=<uuid>&thread_id=<user_16hex>&website_language=en
```

### Client ‚Üí Server

```json
{ "type": "text_query",  "text": "Hello", "local_time": "2025-10-30 10:00:00", "muteAudio": false }
{ "type": "audio_query", "audio": "<base64|dataurl>", "format": "webm", "muteAudio": true }
{ "type": "mute_audio" }
{ "type": "unmute_audio" }
{ "type": "stop_audio" }
{ "type": "ping" }
```

> **Audio size limit:** 25 MB.
> Supported auto-detected formats include `webm`, `wav`, `m4a`, `ogg`, `mp3`.

### Server ‚Üí Client

* `connected` ‚Äî handshake info (`bot_id`, `thread_id`)
* `text_query` ‚Äî echo of user text (with `local_time`)
* `response_start` / `response_done` / `response_ended`
* `text_token` ‚Äî streaming tokens
* `text_sentence` ‚Äî finalized sentences (with optional `emotion`)
* `audio_response` ‚Äî base64 TTS chunks (`audio`) + `viseme` frames
* `slides_response` ‚Äî `{title, summary, editorjs}` payload(s)
* `slides_done` ‚Äî end-of-slides marker
* `audio_muted` ‚Äî `{muted: boolean}`
* `stop_audio` ‚Äî confirmation
* `error` ‚Äî `{message}`
* `pong` ‚Äî ping reply

> **Slides streaming:** the engine may emit one or multiple `slides_response` updates; clients should use the **latest** `editorjs` received for the current answer.

---

## Data Model (response snippets)

> Exact fields come from your serializers; below are representative shapes.

**Agent**

```json
{
  "id": 1,
  "bot_id": "6a97a3c4-5d25-47a8-bb31-b6f35c98e6b7",
  "name": "AI Coach",
  "thumbnail": "https://.../media/agents/1/thumb.png",
  "voice": { "service": "elevenlabs", "voice_id": "..." }
}
```

**Session**

```json
{
  "id": 10,
  "thread_id": "user_ab12cd34ef56gh78",
  "agent": 1,
  "created_at": "2025-10-30T02:11:22Z"
}
```

**Chat**

```json
{
  "id": 123,
  "session": 10,
  "query": "How do I plan my week?",
  "response": "Here‚Äôs a simple 3-step plan...",
  "emotion": { "items": [{"name":"Joy","intensity":2}, ...], "stats": {...} },
  "viseme": { "segments": 3, "frames_total": 480, "last_frames": [[...]] },
  "meta": {
    "schema": "engine.v3",
    "bot_id": "6a97a3c4-5d25-47a8-bb31-b6f35c98e6b7",
    "thread_id": "user_ab12cd34ef56gh78",
    "model": "gpt-4o-mini",
    "timings_ms": { "prepare_ms": 42, "run_ms": 1876, "total_ms": 2120 },
    "response_len": 312,
    "tools": ["search_wikipedia", "generate_or_update_slides"]
  },
  "created_at": "2025-10-30T02:12:05Z"
}
```

**Slides (Editor.js)**

```json
{
  "id": 7,
  "session": 10,
  "title": "Weekly Planning",
  "summary": "A compact guide to plan your week.",
  "editorjs": { "time": 1698650000, "version": "2.x", "blocks": [ ... ] },
  "updated_at": "2025-10-30T02:12:10Z"
}
```

---

## Curl Quickstart

**List Agents**

```bash
curl -H "Authorization: Api-Key $API_KEY" \
  https://ai-coach-pmkn.onrender.com/api/agents/
```

**Create a Session** *(fields depend on serializer; see Swagger UI)*

```bash
curl -X POST -H "Authorization: Api-Key $API_KEY" -H "Content-Type: application/json" \
  -d '{"thread_id":"user_ab12cd34ef56gh78","agent":1}' \
  https://ai-coach-pmkn.onrender.com/api/sessions/
```

**Connect WebSocket** (JS)

```js
const url = new URL("wss://ai-coach-pmkn.onrender.com/ws/chat/");
url.searchParams.set("bot_id", "6a97a3c4-5d25-47a8-bb31-b6f35c98e6b7");
url.searchParams.set("thread_id", "user_ab12cd34ef56gh78");
url.searchParams.set("website_language", "en");
url.searchParams.set("api_key", "<YOUR_API_KEY>");

const ws = new WebSocket(url);
ws.onmessage = (e) => console.log("WS:", JSON.parse(e.data));
ws.onopen = () => ws.send(JSON.stringify({type:"text_query", text:"Hello!", muteAudio:false}));
```

---

## Project Structure (high-level)

```
aicoach/
‚îú‚îÄ api/                 # DRF endpoints (Voices, Agents, Sessions, Chats, Slides)
‚îÇ  ‚îú‚îÄ views.py          # ViewSets with ApiKeyAuthentication + permission
‚îÇ  ‚îú‚îÄ urls.py           # Routers + /api/test/ console
‚îÇ  ‚îî‚îÄ permissions.py    # HasValidAPIKeyAndAllowedOrigin (key + allow-list)
‚îú‚îÄ engine/
‚îÇ  ‚îú‚îÄ rag.py            # Orchestrates: prepare ‚Üí run ‚Üí finalize/persist
‚îÇ  ‚îú‚îÄ nodes.py          # Streaming LLM + TTS + emotion + (sync) slide tool calls
‚îÇ  ‚îú‚îÄ tools.py          # search_wikipedia, generate_or_update_slides (sync path)
‚îÇ  ‚îî‚îÄ tts_stt.py        # TTS/STT integration
‚îú‚îÄ stream/
‚îÇ  ‚îú‚îÄ consumers.py      # WebSocket ChatConsumer (WS protocol above)
‚îÇ  ‚îî‚îÄ ws_auth.py        # WS auth: key via header/query/cookie + origin/host/IP checks
‚îú‚îÄ agent/, memory/      # Models for Agent/Voice and Session/Chat/Slides
‚îú‚îÄ templates/test.html  # Simple test console (WS + REST)
‚îî‚îÄ aicoach/settings.py  # DRF/Channels/Redis/CORS/etc.
```

---

## Environment & Settings

### `.env` (sample)

```dotenv
# Core / Django
DEBUG=true
DJANGO_SECRET_KEY="<set-me>"
BASE_URL=http://127.0.0.1:8000
CACHE_TTL=600

# OpenAI / ElevenLabs
OPENAI_API_KEY="<set-me>"
ELEVENLABS_API_KEY="<set-me>"
OPENAI_STT_MODEL=whisper-1
ELEVENLABS_TTS_MODEL=eleven_multilingual_v2

# Postgres
DATABASE_NAME=aicoach
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_HOST=localhost
DATABASE_PORT=5432
```

### Redis

* `REDIS_URL_CACHE` (default `redis://localhost:6379/1`)
* `REDIS_URL_CHANNELS` (default `redis://localhost:6379/2`)

> Channels uses the `CHANNEL_LAYERS` config to back WebSocket groups.

### CORS/CSRF

* `CORS_ALLOW_ALL_ORIGINS` defaults to `true` for dev
* `CSRF_TRUSTED_ORIGINS` includes `BASE_URL` and a few local hosts by default

---

## Running Locally

> Requires: Python 3.10+, PostgreSQL, Redis

```bash
# 1) Setup
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 2) Environment
cp .env.example .env  # or create as above and set your keys

# 3) Database
python manage.py migrate
python manage.py createsuperuser  # optional

# 4) Static (if needed)
python manage.py collectstatic --noinput

# 5) Start Redis (if not already)
redis-server  # or use Docker: docker run -p 6379:6379 redis:7

# 6) Run server (dev)
python manage.py runserver 0.0.0.0:8000
# or ASGI via Daphne (recommended for WS):
daphne -b 0.0.0.0 -p 8000 aicoach.asgi:application
```

Open:

* Swagger: `http://127.0.0.1:8000/api/schema/swagger-ui/`
* ReDoc: `http://127.0.0.1:8000/api/schema/redoc/`
* Test console: `http://127.0.0.1:8000/api/test/`

---

## Notes & Tips

* **WebSocket auth**: for quick demos, append `?api_key=...` in the WS URL; in production, prefer the `Authorization: Api-Key ...` header at the socket layer if your client library supports it.
* **Thread IDs**: `thread_id` must match `^user_[0-9a-f]{16}$`. Generate one per end-user session.
* **Slides**: The engine‚Äôs slide tool is **synchronous** in this build‚Äîexpect typically a single `slides_response` followed by `slides_done`. Clients should treat additional updates (if any) as replacements.
* **SmartMediaMiddleware**: media fields in API/WS JSON are automatically absolutized to your deployment‚Äôs base URL.
* **Security**: The DRF permission class enforces both a valid API key and an allow-listed origin/host/IP.